#include <stdio.h>
#include <string.h>
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "esp_log.h"
#include "driver/gpio.h"
#include "st7735.h"

struct st7735_dev_t {

    st7735_config_t cfg;
    spi_device_handle_t spi;
};

// Basic 8x8 Font Data (ASCII 32-126)
static const uint8_t font8x8[] = {
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // Space
    0x18,0x3C,0x3C,0x18,0x18,0x00,0x18,0x00, // !
    0x6C,0x6C,0x6C,0x00,0x00,0x00,0x00,0x00, // "
    0x6C,0x6C,0xFE,0x6C,0xFE,0x6C,0x6C,0x00, // #
    0x18,0x3E,0x60,0x3C,0x06,0x7C,0x18,0x00, // $
    0x00,0x63,0x66,0x0C,0x18,0x33,0x63,0x00, // %
    0x38,0x6C,0x7C,0x38,0x6E,0x6C,0x3B,0x00, // &
    0x18,0x18,0x18,0x00,0x00,0x00,0x00,0x00, // '
    0x0C,0x18,0x30,0x30,0x30,0x18,0x0C,0x00, // (
    0x30,0x18,0x0C,0x0C,0x0C,0x18,0x30,0x00, // )
    0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00, // *
    0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00, // +
    0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x30, // ,
    0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00, // -
    0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00, // .
    0x06,0x0C,0x18,0x30,0x60,0xC0,0x80,0x00, // /
    0x3C,0x66,0x6E,0x76,0x66,0x66,0x3C,0x00, // 0
    0x18,0x38,0x18,0x18,0x18,0x18,0x7E,0x00, // 1
    0x3C,0x66,0x06,0x0C,0x18,0x30,0x7E,0x00, // 2
    0x3C,0x66,0x06,0x1C,0x06,0x66,0x3C,0x00, // 3
    0x0C,0x1C,0x3C,0x6C,0xFE,0x0C,0x0C,0x00, // 4
    0x7E,0x60,0x7C,0x06,0x06,0x66,0x3C,0x00, // 5
    0x1C,0x30,0x60,0x7C,0x66,0x66,0x3C,0x00, // 6
    0x7E,0x06,0x0C,0x18,0x30,0x30,0x30,0x00, // 7
    0x3C,0x66,0x66,0x3C,0x66,0x66,0x3C,0x00, // 8
    0x3C,0x66,0x66,0x3E,0x06,0x0C,0x38,0x00, // 9
    0x00,0x18,0x18,0x00,0x18,0x18,0x00,0x00, // :
    0x00,0x18,0x18,0x00,0x18,0x18,0x30,0x00, // ;
    0x0C,0x18,0x30,0x60,0x30,0x18,0x0C,0x00, // <
    0x00,0x00,0x7E,0x00,0x7E,0x00,0x00,0x00, // =
    0x30,0x18,0x0C,0x06,0x0C,0x18,0x30,0x00, // >
    0x3C,0x66,0x06,0x0C,0x18,0x00,0x18,0x00, // ?
    0x3C,0x66,0x6E,0x6E,0x60,0x3E,0x00,0x00, // @
    0x3C,0x66,0x66,0x7E,0x66,0x66,0x66,0x00, // A
    0x7C,0x66,0x66,0x7C,0x66,0x66,0x7C,0x00, // B
    0x3C,0x66,0x60,0x60,0x60,0x66,0x3C,0x00, // C
    0x78,0x6C,0x66,0x66,0x66,0x6C,0x78,0x00, // D
    0x7E,0x60,0x60,0x78,0x60,0x60,0x7E,0x00, // E
    0x7E,0x60,0x60,0x78,0x60,0x60,0x60,0x00, // F
    0x3C,0x66,0x60,0x6E,0x66,0x66,0x3C,0x00, // G
    0x66,0x66,0x66,0x7E,0x66,0x66,0x66,0x00, // H
    0x3C,0x18,0x18,0x18,0x18,0x18,0x3C,0x00, // I
    0x0E,0x06,0x06,0x06,0x06,0x66,0x3C,0x00, // J
    0x66,0x6C,0x78,0x70,0x78,0x6C,0x66,0x00, // K
    0x60,0x60,0x60,0x60,0x60,0x60,0x7E,0x00, // L
    0x63,0x77,0x7F,0x6B,0x63,0x63,0x63,0x00, // M
    0x66,0x6E,0x76,0x66,0x66,0x66,0x66,0x00, // N
    0x3C,0x66,0x66,0x66,0x66,0x66,0x3C,0x00, // O
    0x7C,0x66,0x66,0x7C,0x60,0x60,0x60,0x00, // P
    0x3C,0x66,0x66,0x66,0x66,0x6C,0x36,0x00, // Q
    0x7C,0x66,0x66,0x7C,0x78,0x6C,0x66,0x00, // R
    0x3C,0x66,0x30,0x18,0x0C,0x66,0x3C,0x00, // S
    0x7E,0x5A,0x18,0x18,0x18,0x18,0x18,0x00, // T
    0x66,0x66,0x66,0x66,0x66,0x66,0x3C,0x00, // U
    0x66,0x66,0x66,0x66,0x66,0x3C,0x18,0x00, // V
    0x63,0x63,0x63,0x6B,0x7F,0x77,0x63,0x00, // W
    0x66,0x66,0x3C,0x18,0x3C,0x66,0x66,0x00, // X
    0x66,0x66,0x3C,0x18,0x18,0x18,0x18,0x00, // Y
    0x7E,0x06,0x0C,0x18,0x30,0x60,0x7E,0x00, // Z
    0x3C,0x30,0x30,0x30,0x30,0x30,0x3C,0x00, // [
    0x60,0x30,0x18,0x0C,0x06,0x03,0x01,0x00, // \ (Backslash)
    0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00, // ]
    0x18,0x3C,0x66,0x00,0x00,0x00,0x00,0x00, // ^
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF, // _
    0x30,0x18,0x0C,0x00,0x00,0x00,0x00,0x00, // `
    0x00,0x00,0x3C,0x06,0x3E,0x66,0x3E,0x00, // a
    0x60,0x60,0x7C,0x66,0x66,0x66,0x7C,0x00, // b
    0x00,0x00,0x3C,0x60,0x60,0x66,0x3C,0x00, // c
    0x06,0x06,0x3E,0x66,0x66,0x66,0x3E,0x00, // d
    0x00,0x00,0x3C,0x66,0x7E,0x60,0x3C,0x00, // e
    0x1C,0x30,0x7C,0x30,0x30,0x30,0x30,0x00, // f
    0x00,0x00,0x3E,0x66,0x66,0x3E,0x06,0x3C, // g
    0x60,0x60,0x7C,0x66,0x66,0x66,0x66,0x00, // h
    0x18,0x00,0x38,0x18,0x18,0x18,0x3C,0x00, // i
    0x06,0x00,0x06,0x06,0x06,0x66,0x3C,0x00, // j
    0x60,0x60,0x66,0x6C,0x78,0x6C,0x66,0x00, // k
    0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00, // l
    0x00,0x00,0x6B,0x7F,0x7F,0x6B,0x63,0x00, // m
    0x00,0x00,0x7C,0x66,0x66,0x66,0x66,0x00, // n
    0x00,0x00,0x3C,0x66,0x66,0x66,0x3C,0x00, // o
    0x00,0x00,0x7C,0x66,0x66,0x7C,0x60,0x60, // p
    0x00,0x00,0x3E,0x66,0x66,0x3E,0x06,0x06, // q
    0x00,0x00,0x7C,0x66,0x60,0x60,0x60,0x00, // r
    0x00,0x00,0x3E,0x60,0x3C,0x06,0x7C,0x00, // s
    0x30,0x30,0x7C,0x30,0x30,0x36,0x1C,0x00, // t
    0x00,0x00,0x66,0x66,0x66,0x66,0x3E,0x00, // u
    0x00,0x00,0x66,0x66,0x66,0x3C,0x18,0x00, // v
    0x00,0x00,0x63,0x6B,0x7F,0x7F,0x36,0x00, // w
    0x00,0x00,0x66,0x3C,0x18,0x3C,0x66,0x00, // x
    0x00,0x00,0x66,0x66,0x66,0x3E,0x06,0x3C, // y
    0x00,0x00,0x7E,0x0C,0x18,0x30,0x7E,0x00, // z
    0x0C,0x18,0x18,0x70,0x18,0x18,0x0C,0x00, // {
    0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x00, // |
    0x30,0x18,0x18,0x0E,0x18,0x18,0x30,0x00, // }
    0x3B,0x6E,0x00,0x00,0x00,0x00,0x00,0x00, // ~
};

// Commands
#define ST7735_SWRESET 0x01
#define ST7735_SLPOUT  0x11
#define ST7735_FRMCTR1 0xB1
#define ST7735_FRMCTR2 0xB2
#define ST7735_FRMCTR3 0xB3
#define ST7735_INVCTR  0xB4
#define ST7735_PWCTR1  0xC0
#define ST7735_PWCTR2  0xC1
#define ST7735_PWCTR3  0xC2
#define ST7735_PWCTR4  0xC3
#define ST7735_PWCTR5  0xC4
#define ST7735_VMCTR1  0xC5
#define ST7735_GMCTRP1 0xE0
#define ST7735_GMCTRN1 0xE1
#define ST7735_MADCTL  0x36
#define ST7735_COLMOD  0x3A
#define ST7735_CASET   0x2A
#define ST7735_RASET   0x2B
#define ST7735_RAMWR   0x2C
#define ST7735_DISPON  0x29

static void send_cmd(st7735_handle_t dev, uint8_t cmd) {
    gpio_set_level(dev->cfg.dc_pin, 0);
    spi_transaction_t t = {
        .length = 8,
        .tx_buffer = &cmd,
    };
    spi_device_polling_transmit(dev->spi, &t);
}

static void send_data(st7735_handle_t dev, const uint8_t *data, size_t len) {
    if (len == 0) return;
    gpio_set_level(dev->cfg.dc_pin, 1);
    spi_transaction_t t = {
        .length = len * 8,
        .tx_buffer = data,
    };
    spi_device_polling_transmit(dev->spi, &t);
}

static void send_data_u16(st7735_handle_t dev, uint16_t data) {
    uint8_t buf[2] = { data >> 8, data & 0xFF };
    send_data(dev, buf, 2);
}

static void set_addr_window(st7735_handle_t dev, uint16_t x0, uint16_t y0, uint16_t x1, uint16_t y1) {
    send_cmd(dev, ST7735_CASET);
    uint8_t data_x[] = { 0x00, x0 + 2, 0x00, x1 + 2 }; // Offset 2 for 1.8"
    send_data(dev, data_x, 4);

    send_cmd(dev, ST7735_RASET);
    uint8_t data_y[] = { 0x00, y0 + 1, 0x00, y1 + 1 }; // Offset 1 for 1.8"
    send_data(dev, data_y, 4);

    send_cmd(dev, ST7735_RAMWR);
}

esp_err_t st7735_init(const st7735_config_t *cfg, st7735_handle_t *out_handle) {
    st7735_handle_t dev = calloc(1, sizeof(struct st7735_dev_t));
    dev->cfg = *cfg;

    // Configure GPIOs
    gpio_config_t io_conf = {
        .pin_bit_mask = (1ULL << cfg->dc_pin) | (1ULL << cfg->rst_pin),
        .mode = GPIO_MODE_OUTPUT,
    };
    gpio_config(&io_conf);

    spi_device_interface_config_t devcfg = {
        .clock_speed_hz = 20 * 1000 * 1000,
        .mode = 0,
        .spics_io_num = cfg->cs_pin,
        .queue_size = 7,
    };

    esp_err_t ret = spi_bus_add_device(cfg->host, &devcfg, &dev->spi);
    if (ret != ESP_OK) return ret;

    // Reset
    gpio_set_level(cfg->rst_pin, 0);
    vTaskDelay(pdMS_TO_TICKS(100));
    gpio_set_level(cfg->rst_pin, 1);
    vTaskDelay(pdMS_TO_TICKS(100));

    send_cmd(dev, ST7735_SWRESET);
    vTaskDelay(pdMS_TO_TICKS(150));
    send_cmd(dev, ST7735_SLPOUT);
    vTaskDelay(pdMS_TO_TICKS(500));

    // Basic Init Sequence
    send_cmd(dev, ST7735_COLMOD);
    uint8_t colmod = 0x05; // 16-bit color
    send_data(dev, &colmod, 1);

    send_cmd(dev, ST7735_MADCTL);
    uint8_t madctl = 0xC8; // BGR, Right-side up
    send_data(dev, &madctl, 1);

    send_cmd(dev, ST7735_DISPON);
    
    *out_handle = dev;
    return ESP_OK;
}

void st7735_clear(st7735_handle_t dev, uint16_t color) {
    st7735_fill_rect(dev, 0, 0, ST7735_WIDTH, ST7735_HEIGHT, color);
}

void st7735_fill_rect(st7735_handle_t dev, uint16_t x, uint16_t y, uint16_t w, uint16_t h, uint16_t color) {
    if ((x >= ST7735_WIDTH) || (y >= ST7735_HEIGHT)) return;
    if ((x + w - 1) >= ST7735_WIDTH) w = ST7735_WIDTH - x;
    if ((y + h - 1) >= ST7735_HEIGHT) h = ST7735_HEIGHT - y;

    set_addr_window(dev, x, y, x + w - 1, y + h - 1);

    uint8_t data[2] = { color >> 8, color & 0xFF };
    gpio_set_level(dev->cfg.dc_pin, 1);

    // Optimized: send color in chunks
    for (int i = 0; i < w * h; i++) {
        spi_transaction_t t = {
            .length = 16,
            .tx_buffer = data,
        };
        spi_device_polling_transmit(dev->spi, &t);
    }
}

void st7735_draw_pixel(st7735_handle_t dev, uint16_t x, uint16_t y, uint16_t color) {
    if (x >= ST7735_WIDTH || y >= ST7735_HEIGHT) return;
    set_addr_window(dev, x, y, x, y);
    send_data_u16(dev, color);
}

void st7735_draw_string(st7735_handle_t dev, uint16_t x, uint16_t y, const char *text, uint16_t color, uint16_t bg_color) {
    while (*text) {
        uint8_t c = *text;
        if (c >= 32 && c <= 126) {
            const uint8_t *bitmap = &font8x8[(c - 32) * 8];
            for (int i = 0; i < 8; i++) {
                for (int j = 0; j < 8; j++) {
                    if (bitmap[i] & (1 << j)) {
                        st7735_draw_pixel(dev, x + j, y + i, color);
                    } else if (bg_color != color) {
                        st7735_draw_pixel(dev, x + j, y + i, bg_color);
                    }
                }
            }
        }
        x += 8;
        text++;
        if (x + 8 > ST7735_WIDTH) break;
    }
}
